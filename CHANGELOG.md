# CHANGELOG

這份檔案用來記錄專案的重要更新（功能、修正、文件）。

格式說明：
- `Added`：新功能
- `Changed`：行為或介面調整
- `Fixed`：錯誤修正
- `Docs`：文件更新

## [Unreleased]

### Added
- 新增 `ui/shared/runtime.py`：提供模組級 runtime symbol 顯式註冊器，取代 `ctx=globals()` 注入模式。
- 新增 CLI 測試 `tests/test_cli.py` 與 DI 測試 `tests/test_di.py`。
- 新增 `conf/` + `config_loader.py`，提供 `Hydra(YAML) / legacy env` 雙軌配置載入（預設仍維持 legacy env）。
- 新增 `storage/duck_store.py`（`DuckDB + Parquet` hybrid）：
  - DuckDB 儲存 metadata / 回測快取 / 任務紀錄
  - Parquet 儲存 `daily_bars`、`intraday_ticks`（market/symbol 分區）
  - 支援啟動時從 legacy SQLite 一次性遷移（僅在目標庫為空時）
- 新增 `scripts/migrate_sqlite_to_duckdb.py` 一次性遷移腳本。
- 新增 `ui/charts/lightweight_adapter.py` 與 `ui/charts/__init__.py`，提供 lightweight-charts 共用渲染封裝。
- 新增測試：
  - `tests/test_config_loader.py`
  - `tests/test_duck_store.py`
- 新增 `symbol_metadata`（SQLite）：
  - 儲存 `symbol / market / name / exchange / industry / currency / source / updated_at`
  - 供公司名稱/產業查詢優先走本地資料，降低重複打外部 API
- 新增 `bootstrap_runs`（SQLite）：
  - 記錄資料預載與每日增量更新任務（範圍、狀態、成功/失敗數、摘要與錯誤）
- 新增 `services/bootstrap_loader.py`：
  - 提供台股 metadata 擷取、全量預載、每日增量更新共用流程
- 新增 `scripts/bootstrap_market_data.py`：
  - 可從 CLI 一次預建台股/美股核心資料（含 metadata + 歷史日K）
- 新增 `00935 熱力圖` 分頁：可批次比較 00935 成分股相對大盤的超額報酬，並用紅綠熱力圖顯示強弱。
- 新增 `0050 熱力圖` 分頁：可批次比較 0050 成分股相對大盤的超額報酬，並用紅綠熱力圖顯示強弱。
- 新增 `ETF輪動` 分頁：固定 `0050/0052/00935/0056/00878/00919` 的日K月頻輪動回測。
- 新增 `資料庫檢視` 分頁：可直接查看 `market_history.sqlite3` 的資料表總覽、欄位結構與分頁資料內容。
- 新增輪動引擎 `backtest/rotation.py`：
  - 大盤濾網（Benchmark > 60MA）
  - 動能加權分數（20/60/120）
  - 每月第一交易日評分、下一交易日開盤調倉
  - Top N 等權持有
- 新增 `rotation_runs`（SQLite）快取輪動回測結果，分頁載入可直接顯示上次結果。
- 新增 `universe_snapshots`（SQLite）用於快取成分股清單，避免每次切分頁都重抓。
- 新增成分股快取讀寫 API：
  - `save_universe_snapshot(...)`
  - `load_universe_snapshot(...)`
- 新增 repo 初始化腳本：`scripts/bootstrap_project_docs.py`，可一鍵建立 LLM 文件骨架。
- 新增 Prompt 範本文件：`PROMPT_TEMPLATES.md`（由初始化腳本建立）。
- 新增 `pre-commit` hook（`.githooks/pre-commit`）與 `scripts/auto_changelog.py`，可在 commit 前自動補 `CHANGELOG.md`。
- 新增 `scripts/setup_git_hooks.sh`，可一鍵設定 `core.hooksPath=.githooks`。
- 新增 Fugle MCP 啟動腳本：`scripts/run_fugle_mcp_server.sh`（支援 `FUGLE_MARKETDATA_API_KEY -> API_KEY` 映射）。
- 新增 `intraday_ticks`（SQLite）即時資料表與讀寫 API：
  - `save_intraday_ticks(...)`
  - `load_intraday_ticks(...)`
  - 支援 `REALTIME0052_INTRADAY_RETAIN_DAYS`（預設 1095 天）控管保留天數。
- Fugle API key 讀取新增 key file fallback：
  - 預設讀取 `~/Library/Mobile Documents/com~apple~CloudDocs/codexapp/fuglekey`
  - 可用 `FUGLE_MARKETDATA_API_KEY_FILE` / `FUGLE_API_KEY_FILE` 覆蓋。
- 新增台股歷史 provider：`tw_fugle_rest`（Fugle Historical Candles 日K），支援長區間分段拉取後合併。
- 回測工作台新增 `回測前自動補資料缺口（推薦）`：
  - 先檢查本地區間覆蓋度
  - 僅對缺口標的做增量同步，降低「回測天數不夠」機率。
- 新增 `2025 前十大 ETF` 與 `2026 YTD 前十大 ETF` 兩個獨立卡片頁：
  - 以 TWSE `MI_INDEX` 全市場快照計算區間報酬率前十名
  - 顯示市值型/股利型/其他分類統計與期初期末收盤價
- 新增 `2026 YTD 主動式 ETF` 獨立卡片頁：
  - 以「代碼結尾 A + 名稱含主動」規則篩出台股主動式 ETF，顯示 2026 YTD Buy & Hold（復權版）績效排序
  - 新增 `Benchmark 對照卡`：同圖比較策略曲線（主動式ETF等權）、基準曲線與各ETF買進持有曲線
  - 每檔 ETF 曲線使用高對比、不相近配色，提升多檔比較辨識度
- 新增 `共識代表 ETF` 分頁：
  - 以當期前10 ETF 成分股交集推導「單一代表 ETF」與前3備選
  - 主分數採 `交集權重覆蓋率`（交集股在 ETF 內的可用權重覆蓋）
  - 若嚴格交集為空，會自動降級交集門檻並顯示門檻說明
- 新增 `兩檔 ETF 推薦` 分頁：
  - 以 `共識代表 ETF` 作為核心檔，搭配前10 ETF 中「低重疊 + 高 YTD」衛星檔
  - 支援海外成分納入開關與重疊門檻（Jaccard）設定
  - 若原始門檻無候選，會自動放寬到 `20%`，再不行才回退為最高 YTD
- 回測工作台新增 `DCA 比較卡`：
  - 支援 `期初投入 + 每月定期定額`（每月首個交易日收盤）
  - 多標的採等權投入，並套用手續費/滑價成本
  - 可同時比較 `DCA 策略` 與 `Benchmark DCA` 的期末淨值與超額報酬
- 新增 `00910 熱力圖` 獨立卡片頁：
  - 可列出全部成分股清單
  - 可執行與 `00935` 同級的成分股熱力圖回測
  - 新增 `全球成分股 YTD（Buy & Hold）` 分組熱力圖：台股對台股基準、海外對海外基準，並以共同交易日對齊計算超額報酬
  - 新增 `00910 / 00935 / 0050` 頁首「官方指數編製標準摘要」與來源連結
- 新增 `00993A 熱力圖` 獨立卡片頁：
  - 可載入 `00993A` 成分股清單並執行相對大盤熱力圖回測
  - 沿用既有台股熱力圖參數（Benchmark / 策略 / 成本 / 同步選項）與結果呈現流程
- 新增 `00735 熱力圖` 固定卡片頁：
  - 沿用 `00935 熱力圖` 同級流程（更新成分股、回測、熱力圖、公司簡介）
- 新增 `backtest_replay_runs`（SQLite）：
  - 回測工作台可持久化完整回放資料（含曲線/訊號/交易）
  - 同條件可直接讀取快取，減少重複回測等待時間
- 新增熱力圖頁下方「成分股公司簡介」區塊：
  - `0050 / 00935`：顯示 `排名 / 代號 / 名稱 / 權重 / 產業 / 核心業務 / 產品面向`
  - `00910`：顯示全球成分股 `排名 / 市場 / 權重 / 公司簡介`
- 新增 ETF 成分股完整欄位擷取與解析（`get_etf_constituents_full`）：
  - 可回傳 `rank / symbol / name / market / weight_pct / shares / tw_code`
  - 可識別海外市場代碼（如 `.US/.JP/.KS`），供 00910 全球分組熱力圖與公司簡介使用

### Changed
- Auto: updated app.py, cli.py, di.py, ui/core/charts.py, ui/pages/backtest.py, ui/pages/live.py [id:6bec13c581]
- Auto: updated .gitignore, AGENTS.md, PROJECT_CONTEXT.md, README.md, app.py, cli.py, ... (+13) [id:1692175dad]
- `ui/pages/live.py`、`ui/pages/backtest.py`、`ui/core/charts.py` 移除 `_bind_ctx/_CTX_BOUND` 與 `ctx=globals()`，改為顯式 runtime 註冊。
- `app.py` 新增 `_ensure_ui_runtime_configured()`，統一在呼叫頁面/圖表模組前注入必要 runtime symbols。
- `app.py` 的 `_market_service/_history_store` 改由 `di.py` 容器工廠提供，避免重複初始化路徑。
- `cli.py` 由 placeholder 改為可執行 `sync/backtest/bootstrap/info/serve`，並新增 `pyproject.toml` script entry：`realtime0052=cli:main`。
- `.gitignore` 新增 `market_history.duckdb`、`parquet/`，並將既有追蹤中的本地資料產物移出版本控管。
- `pyproject.toml` 移除 `F821` 豁免，並修正 `mypy` 掃描路徑為 `ui/loaders.py`。
- Auto: updated .gitignore, conf/tw_etf_management_fees_missing.csv, docs/plan-architecture-tooling-docs.md, docs/plan-performance-special.md, market_history.duckdb, parquet/daily_bars/market=TW/symbol=1560/bars.parquet, ... (+46) [id:ee902adf1e]
- Auto: updated app.py, tests/test_active_etf_page.py, ui/pages/backtest.py [id:9de9c361b8]
- Auto: updated storage/duck_store.py [id:fe2ef6efc2]
- Auto: updated .githooks/pre-commit, .github/workflows/ci.yml, AGENTS.md, PROJECT_CONTEXT.md, README.md, app.py, ... (+4) [id:f09ec6a4f6]
- Auto: updated AGENTS.md, PROJECT_CONTEXT.md, README.md, advice.py, app.py, backtest/__init__.py, ... (+70) [id:0714b64ee6]
- Auto: updated .githooks/pre-commit, app.py, pyproject.toml, services/backtest_runner.py, services/benchmark_loader.py, storage/duck_store.py, ... (+10) [id:74fc551790]
- `台股 ETF 全類型總表` 的基金規模追蹤表升級：
  - `更新規模追蹤` 改為以當日（若遇非交易日則取最近交易日）逐日累積寫入基金規模快照
  - 基金規模資料改為資料庫永久保留（`keep_days<=0` 不裁切），後續可按需求回查全量歷史
  - 追蹤表畫面改為僅顯示最近 `10` 個交易日
  - 追蹤表新增左側 `編號` 欄，日期欄改為 `YYYY-MM-DD(億)`，數值顯示整數（無小數）
  - `台股代號` 改為可點擊帶入回測，`ETF名稱` 改為可點擊開啟 ETF 成分股熱力圖
  - 色塊規則調整為僅標示 `單日規模成長 > 10%`（粉紅底）
- 補齊工程品質基線：
  - `pyproject.toml` 新增 `pytest` 設定（`pythonpath=["."]`），讓 `uv run pytest` 可直接執行
  - `pyproject.toml` 將 `mypy` 收斂為可落地的初始掃描範圍（`utils`、`ui/helpers`）
  - `.githooks/pre-commit` 新增 `uv run mypy`（沿用既有 `ruff` + changelog 自動補記）
  - 新增 `.github/workflows/ci.yml`，在 Python `3.10/3.12` 執行 `compileall`、`unittest`、`pytest smoke`、`ruff`、`mypy`
- 修正 `回測工作台` 在 `ctx=globals()` 過渡模式下的 NameError（`runner_parse_symbols` 未定義）：
  - `app.py` 補回 `ui/pages/backtest.py` 依賴的 runner/cache/chart/import aliases
  - 避免進入回測頁時因依賴未注入而中斷
- 移除 `ctx=globals()` 相容層的執行期 deprecation 噪音：
  - `app.py` 不再主動發出 `Passing ctx=globals() is deprecated` 警告
  - `ui/pages/live.py`、`ui/pages/backtest.py`、`ui/core/charts.py` 的 `_bind_ctx` 改為靜默相容橋接
- 修正 `即時看盤` fragment 偶發 NameError（`_normalize_ohlcv_frame` 未定義）：
  - `app.py` 新增 `_normalize_ohlcv_frame = normalize_ohlcv_frame` 相容 alias
  - 確保 `ui/pages/live.py` 在 `ctx=globals()` 過渡期可穩定取得 OHLCV 正規化函式
- Auto: updated README.md, providers/us_twelve.py, tests/test_us_twelve_provider.py [id:c44e63caba]
- Auto: updated data_sources.py, tests/test_data_sources.py [id:b435b20941]
- Auto: updated services/sync_orchestrator.py, tests/test_sync_orchestrator.py [id:2487a039f8]
- 同步/儲存效能優化（第一階段）：
  - `DuckHistoryStore` 初始化新增常用查詢索引（`symbol_metadata`、`sync_state`、`heatmap_runs`、`rotation_runs`、`backtest_replay_runs` 等），降低資料量成長後的全表掃描風險。
  - 新增 `load_sync_state(...)` 與 `load_daily_coverage(...)`（DuckDB/SQLite 都支援），供同步規劃優先走輕量 metadata/coverage 查詢。
  - `sync_symbols_if_needed(...)` 優先使用 `sync_state` + `daily_coverage` 判斷是否需同步，僅在缺少 coverage API 時才回退 `load_daily_bars(...)`。
  - `DuckHistoryStore.load_daily_bars(...)` 改為 DuckDB `read_parquet` 視窗化查詢（先篩日期再載入），降低短區間查詢的不必要反序列化成本。
  - 新增對應測試：`tests/test_sync_orchestrator.py`（fast-path/coverage）與 `tests/test_duck_store.py`（coverage/sync_state）。
- 效能優化（第二階段）：
  - `DuckHistoryStore.queue_daily_bars_writeback(...)` 改為同 key coalescing（併單）機制：同一標的重複寫回不再丟棄，改為合併後由背景 worker 批次落盤。
  - 背景寫回 executor 由固定單 worker 改為可設定並行（`REALTIME0052_DUCK_WRITEBACK_WORKERS`，預設 2），提升多標的回寫吞吐。
  - 熱力圖 `compute_heatmap_rows(...)` 新增 `max_workers`，可平行計算多檔標的回測列，縮短大成分池等待時間。
  - 輪動 `prepare_rotation_bars(...)` 新增平行預處理（split adjustment）路徑，並保留輸出順序。
  - 回測頁 `session_state` 大型 payload 快取改為僅保留最近 3 筆，降低長時間操作後的記憶體膨脹與 rerun 序列化負擔。
  - 新增對應測試：`tests/test_duck_store.py`（writeback coalescing）、`tests/test_heatmap_runner.py`（parallel heatmap）、`tests/test_rotation_runner.py`（parallel rotation）。
- 效能優化（第三階段）：
  - `DuckHistoryStore` 的日K/分時寫入改為 `append delta parquet`，不再每次 upsert 都讀舊檔並整檔重寫。
  - 讀取日K/分時時，會合併 `base + delta` 並以 `date/ts_utc` 去重（依 `fetched_at` 最新優先），確保查詢結果一致。
  - 新增 compact 機制：當 delta 檔數達門檻時自動 roll-up 成 base 檔（可用環境變數 `REALTIME0052_DAILY_DELTA_COMPACT_THRESHOLD`、`REALTIME0052_INTRADAY_DELTA_COMPACT_THRESHOLD` 調整）。
  - 新增測試：`tests/test_duck_store.py`（daily/intraday delta compaction 路徑）。
- `台股 ETF 全類型總表` 新增「基金規模追蹤（最近22交易日）」：
  - 新增 `tw_etf_aum_history` 持久化資料表（SQLite/DuckDB），記錄 `etf_code/etf_name/trade_date/aum_billion`，目前改為可永久累積保留。
  - 全類型頁面新增「更新規模追蹤」按鈕，手動更新當日規模快照；追蹤表顯示寬表日期欄位並標示異常變動（`>+10%` 粉紅）。
  - 新增測試：`tests/test_history_store.py`、`tests/test_duck_store.py`（AUM history API），`tests/test_active_etf_page.py`（寬表/異常標示）。
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, ui/core/__init__.py, ui/core/charts.py, ui/core/health.py, ... (+4) [id:2c82b8503d]
- 架構重構（第一波，瘦身 `app.py`）：
  - 新增 `ui/pages/live.py`、`ui/pages/backtest.py`，將 `即時看盤` 與 `回測工作台` 主流程搬離 `app.py`
  - 新增 `ui/core/charts.py`，集中管理 Benchmark / Live / 指標副圖渲染函式
  - 新增 `ui/core/page_registry.py`、`ui/core/health.py`，抽離頁面導覽與資料健康度 helper
  - `app.py` 相關函式改為 thin wrapper，頁面路由與核心流程維持既有行為
- Auto: updated storage/duck_store.py, storage/history_store.py, tests/test_duck_store.py, tests/test_history_store.py [id:0e867bc138]
- Auto: updated README.md, app.py, conf/tw_etf_management_fees.json, scripts/manage_tw_etf_fees.py [id:e82c0cab0d]
- Auto: updated conf/tw_etf_management_fees.json, services/heatmap_runner.py, storage/duck_store.py, storage/history_store.py, tests/test_duck_store.py, tests/test_heatmap_runner.py, ... (+1) [id:4bc6c67a8b]
- Auto: updated app.py, tests/test_active_etf_page.py [id:14cbfe2554]
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, backtest/adjustments.py, tests/test_active_etf_page.py, tests/test_split_adjustments.py [id:a69a023b1b]
- 分頁調整：原 `2025 前十大 ETF` 改為 `2026 YTD 前十大股利型、配息型 ETF`（台股），並沿用 `2026 YTD 前十大 ETF` 的同級內容（`2025績效`、`贏輸台股大盤`、Benchmark 對照圖與績效表）。
- 新增 `2025 後20大最差勁 ETF` 卡片頁：以 2025 全年區間 `輸給台股大盤(%)` 最多排序顯示後20名，且排除區間內有復權事件標的，版型與 Benchmark 圖比照 `2026 YTD 前十大 ETF`。
- 新增 `ETF代碼 -> 類型` 白名單，分類時優先採用白名單，再回退名稱關鍵字，降低大量落入 `其他` 的情況。
- 新增 `台股 ETF 全類型總表` 卡片：列出台股 ETF 全名單與類型，並同時顯示 `2025績效(%)`、`2026YTD績效(%)`、`贏輸台股大盤2025(%)`、`贏輸台股大盤2026YTD(%)`（僅表格，不含 Benchmark 圖）。
- 新增全域表格「代碼可點擊回測」：所有含代碼欄位的表格都可直接點擊代碼，系統會自動跳轉到 `回測工作台`，帶入標的與市場並自動執行回測。
- `台股 ETF 全類型總表` 新增 `ETF` 中文名稱點擊開啟熱力圖：點擊後可在新分頁以動態 ETF 代碼載入完整熱力圖內容（同 `00935` 卡片等級）。
- 動態 ETF 熱力圖頁補齊自動建置快取流程：從 `台股 ETF 全類型總表` 點擊名稱開啟時，若該 ETF 尚無熱力圖快取，會自動更新成分股並直接執行回測；若已有快取則預設重用，僅在成分股或本地市場資料較快取更新時才自動重算。
- ETF 相關卡片表格統一新增 `管理費` 欄位（白名單可維護，支援 `0.15%起` 級距格式；已預填核心 ETF 費率，未收錄顯示 `—`），涵蓋 Top10/全類型/主動式/共識代表/兩檔推薦等頁面。
- 新增 `scripts/manage_tw_etf_fees.py`：可輸出管理費覆蓋率/待補清單（含 AUM 排序），並支援 `--set` 或 `--input-csv` 分批補值到 `conf/tw_etf_management_fees.json`。
- 管理費白名單改為依設定檔簽章快取載入（約 2 分鐘 TTL）：補值後通常不需重啟 App 即可生效。
- ETF 相關卡片表格同步新增 `ETF規模(億)` 欄位：資料來源為 TWSE `etfExcel` 的資產規模欄位，快取載入；缺值顯示 `—`。
- 新增 `conf/tw_etf_management_fees.json` 作為管理費公開資料快照來源，`app.py` 會自動載入 `fees` 映射（目前快照覆蓋 75/216 檔，其餘維持 `—`）。
- 熱力圖方塊新增 `權重` 資訊：方塊文字與 hover 同步顯示；若有成分股權重資料會帶入，否則顯示 `—`。
- 新增「熱力圖總表」區塊與持久化：記錄已開啟 ETF、開啟次數、最近開啟時間，並支援勾選「釘選為獨立卡片」動態加入導覽卡片。
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, conf/config.yaml, conf/features/default.yaml, conf/storage/duckdb.yaml, ... (+20) [id:1c648218cb]
- 預設技術線切換為 `Hydra + DuckDB/Parquet`：
  - `conf/config.yaml` 預設 storage 改為 `duckdb`
  - `conf/features/default.yaml` 預設 `config_source=hydra`、`storage_backend=duckdb`
  - `app.py` 在未設環境變數時預設走 DuckDB，保留 `rollback_legacy_stack.sh` 可回滾 SQLite
- `app.py` 新增可回滾的 feature flags（可在 DuckDB / SQLite 間切換）：
  - `storage backend`：`sqlite` / `duckdb`
  - `kline renderer (live/replay)`：`plotly` / `lightweight`
  - `benchmark renderer`：`plotly` / `lightweight`
- 回測工作台 `Benchmark` 外部 fallback（如 yfinance/proxy）成功後，會以背景佇列非阻塞寫回 DuckDB/Parquet，降低下次重複查詢時的網路延遲與限流風險。
- `即時看盤`、`回放圖卡`、`Benchmark 對照圖` 新增 lightweight 渲染分支，渲染失敗會自動回退 Plotly。
- `資料庫檢視` 分頁改為同時支援 SQLite 與 DuckDB。
- Auto: updated backtest/__init__.py, backtest/comparison.py, tests/test_comparison.py [id:ee4e5fafdc]
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, services/__init__.py, services/backtest_runner.py, services/heatmap_runner.py, ... (+8) [id:93beeba92f]
- Auto: updated AGENTS.md, GIT_GITHUB_GUIDE.md, PROJECT_CONTEXT.md, PROMPT_TEMPLATES.md, README.md [id:c20efff0af]
#### Manual Summary
- Phase-1 重構落地（效能優先）：
  - 新增 `services/backtest_runner.py`、`services/heatmap_runner.py`、`services/rotation_runner.py`，抽出回測/熱力圖/輪動的資料準備與執行流程。
  - `app.py` 三大熱點頁面改為呼叫 runner，減少重複同步/載入/計算邏輯。
  - 新增 `ui/shared/perf.py`（`REALTIME0052_PERF_DEBUG=1` 可顯示頁面分段耗時）與 `ui/shared/session_utils.py`（集中預設 key 初始化）。
  - 新增測試：`test_backtest_runner.py`、`test_heatmap_runner.py`、`test_rotation_runner.py`。
- `MarketDataService.get_tw_symbol_names/get_tw_symbol_industries` 改為「SQLite 優先、API 補抓、結果回寫 SQLite」，降低重複網路請求。
- `資料庫檢視` 分頁新增「市場基礎資料預載」操作區，並支援顯示最近任務摘要/錯誤。
- App 啟動後新增「每日一次」自動增量更新（有 seed symbols 時才執行），任務摘要回寫 `bootstrap_runs`。
- 新增共用資料健康度顯示（`as_of/source/source chain/degraded/fallback_depth`）到即時看盤、ETF 排行與 Benchmark 對照卡。
- 新增錯誤訊息分級 helper（error/warning/info），統一 ETF 排行與 Benchmark 卡片訊息語意。
- 回測回放快取新增 `schema_version + source_hash` 相容性檢查，不相容時自動重算。
- 抽出共用 helper：快照健康度、同步錯誤摘要、回測快取載入驗證流程。
- Benchmark 載入層重構並抽出 `services/benchmark_loader.py`，熱力圖/輪動/Benchmark 比較卡共用同一流程。
- 回測快取 key/簽章標準化：新增 `services/backtest_cache.py` 共用 `run_key` 與簽章組成。
- 回測工作台 state key 集中到 `state_keys.py`，降低 widget/session key 衝突。
- 回測回放 payload 升級為 `v3`（`meta/bars/results`），快取 schema 升級為 `3`，並維持舊版相容載入。
- 新增 `services/sync_orchestrator.py`，統一 `all/backfill/min_rows` 同步流程。
- 新增 `深色專業（Data Dark）` 主題，並統一 Benchmark 線條視覺樣式（主題色 + 虛線）。
- `回測工作台` 改為「輸入條件即自動回測」：移除手動執行按鈕、先讀 SQLite 快取、回放預設停在最後一根。
- `回測工作台` 新增 `還原權息計算（Adj Close）`，並避免與分割調整重複套用。
- 回測工作台「策略 vs 買進持有」比較表整併，新增 `比較區間` 欄位避免重複資訊。
- 熱力圖回測預設起始區間由 3 年調整為 5 年。
- `2026 YTD 主動式 ETF` 與 `2026 YTD 前十大 ETF` 強化比較能力：新增 `2025績效`、`贏輸台股大盤`、`台股大盤固定列`、`更新最新市況` 與 Benchmark 對照圖補強。
- `2025 前十大 ETF` 與 `2026 YTD 前十大 ETF` 新增母體資訊：顯示 `前10檔數`、`母體檔數（起訖可比較交集）` 與 `前10占比`，提升排行代表性判讀。
- 多標的比較圖的 Benchmark hover 顯示統一為代碼（例如 `00935`）。
- `0050` 公司簡介表改為依 `權重(%)` 排序；`0050/00935/00910` 熱力圖預設策略改為 `buy_hold`。
- `sync_symbol_history(...)` 補強增量判斷：若僅最新日尚未出新 K，改回報 `stale` 並不中斷流程。
- 台股資料鏈路升級：即時 `Fugle WS -> TW MIS -> TW OpenAPI -> TPEx OpenAPI`；日K同步新增 `TPEx OpenAPI` 後再回退 Yahoo。
- UI 導覽改為卡片式並改為單頁渲染，減少切頁等待；並新增設計協作 `design-tokens.json` 下載。
- 熱力圖/ETF 輪動新增「執行前同步最新日K」開關與多標的平行同步選項；回測頁啟動自動增量同步預設改為關閉。
- SQLite 預設路徑改為「優先 iCloud Drive、否則本地」，並支援 `REALTIME0052_DB_PATH` 覆蓋。
- `sync_symbol_history(...)` 起始日期邏輯補強：可正確回補更早區間資料，已覆蓋區間則維持增量同步。

#### Auto Tracked Files
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, providers/tw_fugle_rest.py, services/market_data_service.py, tests/test_active_etf_page.py, ... (+1) [id:695a12c9e1]
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, market_data_types.py, scripts/bootstrap_market_data.py, services/__init__.py, ... (+17) [id:54e33a04fe]
- Auto: updated .gitignore, PROJECT_CONTEXT.md, README.md, app.py, market_data_types.py, tests/test_active_etf_page.py [id:7909c33419]
- Auto: updated AGENTS.md, PROJECT_CONTEXT.md, README.md, app.py, storage/history_store.py, tests/test_history_store.py, ... (+1) [id:c89bc1cf9d]
- Auto: updated README.md, app.py, tests/test_active_etf_page.py [id:4d84559a83]
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, tests/test_active_etf_page.py [id:e2689afe76]
- Auto: updated app.py [id:13cce7fd07]
- Auto: updated AGENTS.md, PROJECT_CONTEXT.md, README.md, app.py, storage/history_store.py [id:8cdb1d9956]
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py [id:2531f53664]
- Auto: updated README.md, app.py, services/market_data_service.py, tests/test_market_data_service.py [id:4b701c5149]
- Auto: updated PROJECT_CONTEXT.md, README.md, app.py, backtest/__init__.py, backtest/rotation.py, backtest/types.py, ... (+3) [id:3bd6d76b10]
- Auto: updated .githooks/pre-commit, AGENTS.md, PROJECT_CONTEXT.md, README.md, app.py, backtest/__init__.py, ... (+12) [id:d87b9ff71f]

### Fixed
- 修正熱力圖平行同步偶發 DuckDB 交易衝突（例如 `TransactionContext Error: Conflict on tuple deletion!`）：
  - `services/sync_orchestrator.py` 的可重試錯誤判斷新增 `tuple deletion/update conflict`
  - 平行同步遇到此類衝突時，會對失敗 symbol 自動做一次序列重試，降低 00735/00910 海外成分同步噪音
- Twelve Data API key 讀取新增 key file fallback：
  - 預設讀取 `~/Library/Mobile Documents/com~apple~CloudDocs/codexapp/twelvedatakey`
  - 可用 `TWELVE_DATA_API_KEY_FILE` / `TWELVEDATA_API_KEY_FILE` 覆蓋
  - 仍保留 `TWELVE_DATA_API_KEY` 作為最高優先來源
- 修正回測/同步時 Yahoo 缺資料的終端噪音洗版：
  - `data_sources.fetch_yf_ohlcv` 改為優先使用 `Ticker.history(...)` 取單一標的日K
  - 對 `yfinance` logger 加入靜音保護，避免 `$XXXX.TW: possibly delisted` 與 `Failed downloads` 重複訊息刷屏
  - 無資料時仍維持回傳空 DataFrame，交由既有 fallback 與同步錯誤摘要處理
- 修正 DuckDB 平行同步偶發 `Binder Error: Unique file handle conflict`：
  - `services/sync_orchestrator.py` 新增可重試判斷（`Unique file handle conflict` / `Cannot attach market_history`）
  - 平行同步若遇到上述錯誤，僅針對失敗 symbol 自動做一次序列重試，其他 symbol 維持原平行流程
  - 降低熱力圖回測（如 `009803`）在部分成分股同步時的隨機失敗率
- 修正 Benchmark 同步在 `^TWII` 等台股指數代碼的來源路由：
  - `storage/history_store.py` 與 `storage/duck_store.py` 會先判斷是否為台股本地股票/ETF代碼（4~6碼，可含尾碼字母）
  - 非本地代碼（如 `^TWII`）改為直接走 `yahoo`，避免先觸發 `tw_fugle_rest:UNSUPPORTED`、`tw_openapi:EMPTY` 等預期性錯誤噪音
  - 保留既有台股本地代碼鏈路（Fugle/OpenAPI/TPEx/Yahoo fallback）
- 修正回測工作台 `bt_fee_rate / bt_sell_tax / bt_slippage` widget 初始化方式：
  - 避免同時使用 `Session State API` 指定值與 `number_input(..., value=..., key=...)` 造成 `StreamlitAPIException`
  - 改為先正規化 `session_state` 浮點值，再由 widget 透過 `key` 讀取
- 修正 Fugle WebSocket 連線細節：改用官方 `.../stock/streaming` endpoint、`auth.data.apikey` 欄位，並修正微秒時間戳解析，避免 `year out of range` 導致即時報價失敗。
- 修正台股即時走勢來源覆蓋問題：當 Yahoo 1m 回傳空資料時，不再覆蓋 Fugle/MIS 即時 tick 聚合出的 K 線。
- 修正即時看盤名稱欄位空白問題：名稱缺值時改為 `name -> full_name -> 台股代號查名 -> symbol` 多層 fallback。
- 修正台股名稱對照缺漏：`get_tw_symbol_names` 新增 TPEx 上櫃名稱來源補齊（例如 `6510 -> 精測`）。
- 修正前十大 ETF 頁面篩選過嚴導致 `0052` 未納入問題：排除條件改為槓反/期貨/海外與債券商品，保留台股股票型 ETF。
- 修正 ETF 成分股 fallback 邏輯：未知代碼不再誤用 `00935` 成分股作為預設。
- 修正台股即時走勢偶發空白：日級報價來源（TW OpenAPI/TPEx）不再使用舊交易日時間戳作為即時 tick，並新增 SQLite 即時快取回補走勢。
- 改善台股即時走勢可讀性：當 tick 聚合 K 線過少（例如僅 1 根）時，自動改用 Fugle Historical `1m` 補齊圖表。
- 改善台股即時走勢補齊策略：不只空資料，當 K 數偏少時也會嘗試用本地 SQLite 快取補齊（僅在 K 數變多時套用）。
- 改善台股即時走勢體感：新增 `last-good 1m` 快取回退（Yahoo/Fugle 1m 暫時失敗時沿用最近成功資料）。
- 改善台股即時走勢穩定度：當 1m 即時資料仍不足時，自動改用 `日K尾段(260)` 顯示，避免僅剩 1 根 K。
- 修正台股即時走勢分割斷層：即時圖也套用已知分割調整（例如 `0052`），避免未復權造成價格斷崖。
- 即時走勢分割邏輯與回測對齊：改為 `known + auto-detect`，不侷限單一個股。
- 修正即時看盤漲跌/漲跌幅顯示：當來源缺 `prev_close` 時，改由日K/即時K自動回推計算，台股與美股皆適用。
- 修正即時看盤漲跌 fallback 的前收基準：改為依 quote 時間挑選正確前收（日K/分K），避免固定取 `[-2]` 造成偏移。
- 即時總覽新增 `漲跌計算依據` 顯示，便於判讀目前採用的來源與前收來源。
- 調整 `股癌風格(心法/檢核)` 建議輸出：新增「倉位建議區間」與中性市況小倉試單節奏，降低幾乎全程空手的體感。
- 修正台股日K走 Yahoo fallback 時未正規化代碼問題：4~6 碼代號自動改為 `.TW`（如 `0050 -> 0050.TW`），指數代碼（如 `^TWII`）維持原樣。
- 熱力圖與 ETF 輪動分頁新增同步錯誤可見提示：若部分標的或 Benchmark 同步失敗，UI 會顯示摘要警示且仍盡量使用本地可用資料。
- 統一含海外成分 ETF 的熱力圖頁成分股顯示：
  - 新增「完整成分股（含海外）」區塊，會列出如 `.KS` 等海外成分
  - 「全球成分股 YTD（Buy & Hold）」區塊改為可套用到所有含海外成分 ETF（不再只限 00910）
  - 原「查看全部成分股」改為「查看台股可回測成分股」，避免與海外完整名單混淆
- 修正海外代碼誤判台股代碼問題：像 `005930.KS` 不再被錯誤解析為台股 `0059`，避免海外成分被歸到台股子集合。
- 修正回測工作台 `bt_market` 自動切市場時序：改為在 widget 建立前預先推斷 + `bt_symbol` 的 `on_change` 回調更新，避免輸入 OTC 代碼時觸發 `StreamlitAPIException`。
- 修正回測工作台「投組分項策略績效卡 / 交易明細卡」文字發糊體感：
  - 新增清晰表格渲染樣式（CJK 字型與字體平滑）
  - 兩張卡改用清晰表格呈現，保留大量資料時自動回退高效模式
- Python 相容性升級：
  - `pyproject.toml` 改為 `>=3.10`（移除 3.9 支援）
  - `numpy` 改為 `>=2.1`（相容 Python 3.13+）
  - `streamlit` 改為 `>=1.50`（相容 Python 3.14）
- 新增 `ruff` 與 `mypy` 開發依賴到 `pyproject.toml`
- 新增 `utils/__init__.py`：`normalize_ohlcv_frame()` 統一 OHLCV 標準化邏輯
- 抽出 `app.py`、`services/backtest_runner.py`、`services/benchmark_loader.py` 的重複 OHLCV 正規化到 `utils/` 共用
- 新增 `ui/helpers/`：抽出 `symbol_utils.py`、`url_utils.py` 作為頁面共用工具
- `_bind_ctx` 與 `ctx=globals()` 模式新增 deprecation warnings，預備未來移除過渡設計
- `use_container_width` 改為 `width='stretch'`（85 處），相容未來 Streamlit 版本
- SQLite/DuckDB 連線關閉問題修復：
  - `storage/history_store.py` 與 `storage/duck_store.py` 新增 `_connect_ctx()` context manager
  - 確保交易 commit/rollback 與連線關閉的正確順序，避免測試環境 `:memory:` 庫關閉後無法重用

### Docs
- 文件一致性整理：
  - `README.md` 修正 repo 路徑 `realtime_0052 -> realtime0052`
  - `AGENTS.md`、`PROJECT_CONTEXT.md` 同步完整分頁與功能範圍描述
  - `CHANGELOG.md` 的 `Unreleased/Changed` 改為 `Manual Summary + Auto Tracked Files`
  - `GIT_GITHUB_GUIDE.md` 改為可重複使用的通用模板
  - `PROMPT_TEMPLATES.md` 改為中文主體（附英文關鍵詞）
- 補齊 App 內 `新手教學`：新增完整分頁地圖、快取/更新按鈕邏輯、Top10/主動式/熱力圖/輪動判讀、常見誤解與建議上手順序。
- `README.md` 新增 `新手快速上手（10 分鐘）`，提供最短操作路徑與各分頁使用時機。
- 補充 `CHANGELOG` 維護說明：`Auto: updated ...` 條目只記錄 staged 檔案變動；本次已補登人工整理的功能摘要與行為說明（涵蓋 2026-02-15 前的遺漏項目）。
- 新增 `FUGLE_MCP_GUIDE.md`：整理 Fugle MCP Server 與 Agent 協作設定步驟與設定範本。
- `README.md` 補充 00935 熱力圖分頁與功能說明。
- `README.md` 補充「LLM 初始化自動化」使用說明。
- `README.md`、`AGENTS.md`、`PROJECT_CONTEXT.md` 補充「自動更新 CHANGELOG」啟用方式與行為。
- `README.md` 補上 `universe_snapshots` 資料表，並更新 `app.py` 說明為六分頁主流程。
- `README.md`、`PROJECT_CONTEXT.md` 更新分頁列表，加入 `資料庫檢視`。

## [0.3.0] - 2026-02-13

### Added
- 新增「策略是否贏過大盤」與「贏/輸大盤百分比」指標。
- 回放預設起點改為第 20 根 K 棒，降低初始空白感。

### Changed
- 預設主題改為灰白色。
- 主題選項精簡為 `日光白` / `灰白專業`。
- K 棒配色改為柔和低飽和半透明風格（粉紅 / 淡綠）。

### Fixed
- 修正 `ui_theme` 在 widget 建立後寫入 `session_state` 造成的 `StreamlitAPIException`。
- 修正即時資料欄位不完整時（缺 `open/high/low/close`）造成的 `KeyError`。

## [0.2.0] - 2026-02-13

### Added
- 新增多主題配色系統（後續已精簡）。
- 即時模式與回測畫面 UI 結構優化。
- 美股資料來源 fallback 強化（Yahoo/Stooq/快取）。
- 新增 `GIT_GITHUB_GUIDE.md` 新手文件。

## [0.1.0] - 2026-02-13

### Added
- 初始版本：即時看盤、回測工作台、SQLite 歷史資料與基本策略功能。
